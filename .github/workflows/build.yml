name: AmurCore Build

on:
  push:
    branches: [ develop ]
#     tags:
#       - '*'

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - { icon: 'â¬›', sys: mingw32 }
          - { icon: 'ðŸŸ¦', sys: mingw64 }
          - { icon: 'ðŸŸ¨', sys: ucrt64  }
          - { icon: 'ðŸŸ§', sys: clang64 }
    name: ðŸš§${{ matrix.icon }} ${{ matrix.sys }}
    defaults:
        run:
            shell: msys2 {0}

    steps:
      - name: 'ðŸ§° Checkout'
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
    
#       - uses: msys2/setup-msys2@v2
#         with:
#             install: mingw-w64-x86_64-toolchain
#             msystem: mingw64
#             release: false

      - name: '${{ matrix.icon }} Setup MSYS2'
      - uses: msys2/setup-msys2@v2
        with:
          msystem: ${{matrix.sys}}
          update: true
          install: >-
            git
            make
            libconfig++
          pacboy: >-
            toolchain:p
            cmake:p
#             ninja:p
            
#       - name: 'ðŸš§ Build TOOL'
#         run: |
#           cmake -G Ninja -B build -DCMAKE_BUILD_TYPE=Release
#           cmake --build build
          
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          dir: '${{ github.workspace }}/example/'
          install-deps: 'true'
          modules: 'qtcharts qtwebengine'
          archives: 'qtbase qtsvg'
          cache: 'false'
          cache-key-prefix: 'install-qt-action'
          setup-python: 'true'
          tools: 'tools_ifw tools_qtcreator,qt.tools.qtcreator'
          set-env: 'true'
          tools-only: 'false'
          aqtversion: '==2.1.*'
          py7zrversion: '==0.19.*'
          extra: '--external 7z'

#       - name: List files in Qt
#         run: find ${{env.Qt5_Dir}}

      - uses: Dovyski/setup-opencv-action@v1.1
        with:
          opencv-version: '4.7.0'

#       - name: Setup cmake
#         uses: jwlawson/actions-setup-cmake@v1.13
#         with:
#           cmake-version: '3.16.x'

      - name: Configure CMake
        env:
          CMAKE_PREFIX_PATH: ${{env.Qt5_Dir}}
        run: cmake -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -B '${{github.workspace}}'/build

      - name: Build
        run: cmake --build '${{github.workspace}}'/build

      - uses: montudor/action-zip@v1
        with:
          args: zip -qq -r AmurCore-${{ github.ref_name }}-windows.zip '${{github.workspace}}'/build

      - name: Release
        if: ${{ github.event.action == 'released' || github.event.action == 'prereleased' }}
        uses: softprops/action-gh-release@17cd0d34deddf848fc0e7d9be5202c148c270a0a
        with:
          files: AmurCore-${{ github.ref_name }}-windows.zip


